// Piano-Rattle// by Thomas Resch, 2006// ported to c from Stefan Belbao's Prepared Piano																									/*																									      *//*-------------------------------------------struct t_rattle----------------------------------------------*//*                                                                                                        */#include "t_rattle.h"#include "ext.h"#include "ext_obex.h"	// required for new style Max object#include "ext_common.h"#include "z_dsp.h"#include "math.h"t_rattle *t_rattle_new(double rattleFrequency_, double rattleMassDensityRatio_, double rattleLength_, int NS_){	t_rattle *x = (t_rattle *) sysmem_newptrclear(sizeof(t_rattle));	x->rattleFrequency = rattleFrequency_;	x->rattleMassDensityRatio = rattleMassDensityRatio_;	x->rattleLength = rattleLength_;	x->lastRattle = 0;	x->rattle = 0;	x->nextRattle = 0;	x->rattleOn = 0;	x->NS = NS_;	//x->rattleForce = (double *) sysmem_newptrclear(sizeof(double)*x->NS);	//x->rattlePosition = (double *) sysmem_newptrclear(sizeof(double)*x->NS);	x->w_2 = pow(2*PI*x->rattleFrequency,2);	x->normRattleIndex = 0.7;    x->rattleIndex = 2;	return x;}void t_rattle_free(t_rattle *x){	sysmem_freeptr(x);	}void t_rattle_set_dxdt(t_rattle *x, double dx_, double dt_){	x->dx = dx_;	x->dt = dt_;	x->dt_2 = pow(x->dt, 2);	x->rattleIndex = 2+floor(x->normRattleIndex/x->dx);}void t_rattle_calculateRattleIndex(t_rattle *x, double normRattleIndex){	x->normRattleIndex = normRattleIndex;	x->rattleIndex = 2+floor(x->normRattleIndex/x->dx);}void t_rattle_setRattleParameters(t_rattle *x, double fundamentalFreq, double massDensityRatio, double rattleLength){	int state = x->rattleOn;	x->rattleOn = 0;          //turn rattle off while changing any parameters.....	x->lastRattle = 0;	x->rattle = 0;	x->nextRattle = 0;	if(fundamentalFreq>0)		x->rattleFrequency = fundamentalFreq;	if(massDensityRatio>0)		x->rattleMassDensityRatio = massDensityRatio;	if(rattleLength>0)		x->rattleLength = rattleLength;	x->w_2 = pow(2*PI*x->rattleFrequency,2);	x->rattleOn = state;	//go back to previous rattle state}void t_rattle_setFundamentalFrequency(t_rattle *x, double fundamentalFreq){    int state = x->rattleOn;    x->rattleOn = 0;          //turn rattle off while changing any parameters.....    x->lastRattle = 0;    x->rattle = 0;    x->nextRattle = 0;        if(fundamentalFreq>0)        x->rattleFrequency = fundamentalFreq;        x->w_2 = pow(2*PI*x->rattleFrequency,2);    x->rattleOn = state;	//go back to previous rattle state}void t_rattle_setMassDensityRatio(t_rattle *x, double massDensityRatio){    int state = x->rattleOn;    x->rattleOn = 0;          //turn rattle off while changing any parameters.....    x->lastRattle = 0;    x->rattle = 0;    x->nextRattle = 0;    if(massDensityRatio>0)        x->rattleMassDensityRatio = massDensityRatio;    x->rattleOn = state;	//go back to previous rattle state}void t_rattle_setRattleLength(t_rattle *x, double rattleLength){    int state = x->rattleOn;    x->rattleOn = 0;          //turn rattle off while changing any parameters.....    x->lastRattle = 0;    x->rattle = 0;    x->nextRattle = 0;    if(rattleLength>0)        x->rattleLength = rattleLength;        x->rattleOn = state;	//go back to previous rattle state}void t_rattle_reset(t_rattle *x){	int state = x->rattleOn;	x->rattleOn = 0;          //turn rattle off while changing any parameters.....	x->lastRattle = 0;	x->rattle = 0;	x->nextRattle = 0;	//x->rattleForce = 0;	//x->rattlePosition = 0;	x->rattleOn = state;	//go back to previous rattle state}void t_rattle_perform(t_rattle *x, double ***nextString, double ***string)    // input is string at rattleIndex...{	double tmp;	int i = 0;    	if(x->rattleOn == 1)	{		for(i=0; i<x->NS; i++)		{			x->rattlePosition[i] = (*string)[i][x->rattleIndex] - x->rattle;			tmp = fabs(x->rattlePosition[i])-x->rattleLength/2.;			x->rattleForce[i] = 0.5*(tmp+fabs(tmp))*t_fsign(x->rattlePosition[i]);					(*nextString)[i][x->rattleIndex] = (*nextString)[i][x->rattleIndex] - x->dt_2*x->w_2*x->rattleMassDensityRatio*x->rattleForce[i];		}		x->nextRattle = 2*x->rattle-x->lastRattle+x->w_2*x->dt_2*t_fsum(x->rattleForce, x->NS)-x->dt_2*9.8;		x->lastRattle = x->rattle;		x->rattle = x->nextRattle;	}}