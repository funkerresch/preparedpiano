// Piano-Trap// by Thomas Resch// ported to c from Stefan Belbao's Prepared Piano																									/*																									    *//*------------------------------------------------------------------------------------------------------*//*		 */#include "ext.h"#include "ext_obex.h"	// required for new style Max object#include "ext_common.h"#include "z_dsp.h"#include "math.h"#include "t_trap.h"t_trap *t_trap_new(double trapFrequency_, double trapMassDensityRatio_, int NS_)   //second is loss{	t_trap *x = (t_trap *) sysmem_newptrclear(sizeof(t_trap));	x->trapFrequency = trapFrequency_;	x->trapMassDensityRatio = trapMassDensityRatio_;	x->trapOn = 0;	x->NS = NS_;	//x->trapForce = (double *) sysmem_newptrclear(sizeof(double)*x->NS);	x->w_2 = pow(2*PI*x->trapFrequency,2);	x->normTrapIndex = 0.5;    x->trapIndex = 2;		return x;}void t_trap_free(t_trap *x){	sysmem_freeptr(x);	}void t_trap_set_dxdt(t_trap *x, double dx_, double dt_){	x->dt = dt_;	x->dx = dx_;	x->dt_2 = pow(x->dt, 2);	x->dt_mul_density_over2 = x->dt*x->trapMassDensityRatio*0.5;	x->trapIndex = 2+floor(x->normTrapIndex/x->dx);}void t_trap_calculateTrapIndex(t_trap *x, double normTrapIndex){	x->normTrapIndex=normTrapIndex;	x->trapIndex = 2+floor(x->normTrapIndex/x->dx);}/* for qq=1:trap_num            trap_force(qq,:) = w1(trap_index(qq,1),:); % calc. pos. diff between center of rattle and string            w(trap_index(qq,1),:) = w(trap_index(qq,1),:)-dt^2*(2*pi*trap(qq,2))^2*(trap_force(qq,:)).^3 -(dt*trap(qq,3)/2)*(w1(trap_index(qq,1),:)-w2(trap_index(qq,1),:));        end */        void t_trap_setTrapParameters(t_trap *x, double fundamentalFreq, double massDensityRatio){	int state = x->trapOn;	x->trapOn = 0;          //turn trap off while changing any parameters.....	if(fundamentalFreq>0)		x->trapFrequency = fundamentalFreq;	if(massDensityRatio>0)		x->trapMassDensityRatio = massDensityRatio;	x->w_2 = pow(2*PI*x->trapFrequency,2);	x->trapOn = state;	//go back to previous trap state}void t_trap_setMassDensityRatio(t_trap *x, double massDensityRatio){    int state = x->trapOn;    x->trapOn = 0;          //turn trap off while changing any parameters.....    if(massDensityRatio>0)        x->trapMassDensityRatio = massDensityRatio;    x->trapOn = state;	//go back to previous trap state}void t_trap_setFundamentalFrequency(t_trap *x, double fundamentalFreq){    int state = x->trapOn;    x->trapOn = 0;          //turn trap off while changing any parameters.....    if(fundamentalFreq>0)        x->trapFrequency = fundamentalFreq;    x->w_2 = pow(2*PI*x->trapFrequency,2);    x->trapOn = state;	//go back to previous trap state}void t_trap_reset(t_trap *x){	int i;	int state;	state = x->trapOn;	x->trapOn = 0;	for(i=0;i<x->NS;i++)		x->trapForce[i] = 0;	x->trapOn = state;}void t_trap_perform(t_trap *x, double ***nextString, double ***string, double ***lastString)    // input is string at trapIndex...{	int i;        if(x->trapIndex >= 1000)        return;        if(x->trapIndex < 0)        return;    	if(x->trapOn == 1)	{		for(i=0;i<x->NS;i++)		{			x->trapForce[i] = (*string)[i][x->trapIndex];			(*nextString)[i][x->trapIndex] = (*nextString)[i][x->trapIndex] - x->dt_2*x->w_2*x->trapForce[i]*x->trapForce[i]*x->trapForce[i] -										 x->dt_mul_density_over2*((*string)[i][x->trapIndex]-(*lastString)[i][x->trapIndex]);		}	}}